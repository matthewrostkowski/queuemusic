<%= render "layout/header" %>

<div class="container mx-auto p-6">
  <div class="mb-6">
    <%= link_to "‚Üê Back to Venue", host_venue_path(@venue), class: "text-green-600 hover:text-green-800" %>
  </div>

  <% if @active_session %>
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <!-- Join Code Card -->
      <div class="lg:col-span-1">
        <div class="bg-gradient-to-br from-green-500 to-green-600 rounded-lg shadow-lg p-6 text-white">
          <p class="text-sm uppercase tracking-widest opacity-90">Join Code</p>
          <p class="text-5xl font-bold font-mono my-4"><%= @active_session.join_code %></p>
          <p class="text-sm opacity-90">Share this code with users to join the queue</p>
          
          <div class="mt-6 pt-6 border-t border-green-400 space-y-3">
            <div class="flex justify-between items-center">
              <span class="text-sm">Users in queue:</span>
              <span class="text-2xl font-bold"><%= @user_count %></span>
            </div>
            <div class="text-sm opacity-90">
              Status: <span class="font-semibold"><%= @active_session.status.upcase %></span>
            </div>
          </div>
        </div>

        <!-- Session Controls -->
        <div class="mt-6 space-y-2">
          <% if @active_session.status == 'active' %>
            <%= button_to "‚è∏ Pause", 
                pause_session_host_venue_path(@venue),
                method: :post,
                class: "w-full px-4 py-2 bg-yellow-500 text-white rounded-lg hover:bg-yellow-600 font-semibold" %>
          <% elsif @active_session.status == 'paused' %>
            <%= button_to "‚ñ∂ Resume", 
                host_venue_resume_session_path(@venue),
                method: :post,
                class: "w-full px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 font-semibold" %>
          <% end %>

          <%= button_to "üîÑ New Code", 
              regenerate_code_host_venue_path(@venue),
              method: :post,
              class: "w-full px-4 py-2 bg-purple-500 text-white rounded-lg hover:bg-purple-600 font-semibold" %>

          <%= button_to "‚èπ End Session", 
              end_session_host_venue_path(@venue),
              method: :post,
              data: { confirm: "End this session?" },
              class: "w-full px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 font-semibold" %>
        </div>
      </div>

      <!-- Queue Info -->
      <div class="lg:col-span-2">
        <!-- Currently Playing -->
        <div class="bg-white rounded-lg shadow p-6 mb-6">
          <h2 class="text-xl font-bold mb-4">üéµ Now Playing</h2>
          <% if @current_song %>
            <div class="flex gap-4">
              <% if @current_song.cover_url.present? %>
                <img src="<%= @current_song.cover_url %>" alt="<%= @current_song.title %>" class="w-24 h-24 rounded object-cover">
              <% else %>
                <div class="w-24 h-24 rounded bg-gray-300 flex items-center justify-center">
                  <span class="text-4xl">üéµ</span>
                </div>
              <% end %>
              <div>
                <p class="text-sm text-gray-600">CURRENTLY PLAYING</p>
                <h3 class="text-2xl font-bold"><%= @current_song.title %></h3>
                <p class="text-gray-700"><%= @current_song.artist %></p>
                <p class="text-sm text-gray-500 mt-2">
                  üë§ <%= @current_song.user&.display_name || "Guest" %>
                </p>
                <div class="mt-2 flex gap-4 text-sm">
                  <span class="üëç <%= @current_song.vote_score %> likes"></span>
                  <% if @current_song.duration_ms.present? %>
                    <span><%= (@current_song.duration_ms / 1000 / 60) %>:<%= ((@current_song.duration_ms / 1000) % 60).to_s.rjust(2, '0') %></span>
                  <% end %>
                </div>
              </div>
            </div>
          <% else %>
            <p class="text-gray-500">No songs in queue yet...</p>
          <% end %>
        </div>

        <!-- Upcoming Songs -->
        <div class="bg-white rounded-lg shadow p-6">
          <h2 class="text-xl font-bold mb-4">üìã Up Next (<%= @upcoming_songs.count %>)</h2>
          <% if @upcoming_songs.any? %>
            <div class="space-y-3 max-h-96 overflow-y-auto">
              <% @upcoming_songs.each_with_index do |item, idx| %>
                <div class="p-3 bg-gray-50 rounded border-l-4 border-green-500 flex items-center gap-3">
                  <span class="text-lg font-bold text-gray-400 w-6"><%= idx + 1 %></span>
                  
                  <div class="flex-1">
                    <p class="font-semibold"><%= item.title %></p>
                    <p class="text-sm text-gray-600"><%= item.artist %></p>
                  </div>
                  
                  <div class="text-right">
                    <p class="text-sm font-bold text-green-600">üëç <%= item.vote_score %></p>
                    <p class="text-xs text-gray-500">by <%= item.user&.display_name || "Guest" %></p>
                  </div>
                </div>
              <% end %>
            </div>
          <% else %>
            <p class="text-gray-500">No songs queued yet...</p>
          <% end %>
        </div>
      </div>
    </div>

    <!-- Auto-refresh script -->
    <script>
      // Refresh dashboard every 10 seconds
      setInterval(() => {
        fetch('<%= host_venue_dashboard_path(@venue, format: :json) %>')
          .then(response => response.json())
          .then(data => {
            // Update the UI with new data
            // This is a simple refresh; you could implement granular updates
            window.location.reload();
          })
          .catch(err => console.error('Dashboard refresh error:', err));
      }, 10000);
    </script>
  <% else %>
    <div class="bg-white rounded-lg shadow p-6 text-center">
      <p class="text-gray-600 mb-4">No active session. Create one from the venue page.</p>
      <%= link_to "Back to Venue", host_venue_path(@venue), class: "text-green-600 hover:text-green-800 font-semibold" %>
    </div>
  <% end %>
</div>